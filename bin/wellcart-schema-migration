#!/usr/bin/env php
<?php
/**
 * WellCart Platform
 *
 * @copyright  Copyright (c) 2016 WellCart Development Team    http://wellcart.org/
 * @license    http://www.opensource.org/licenses/BSD-3-Clause New BSD License
 */

use WellCart\Mvc\Application;
use WellCart\Utility\Config;
use WellCart\Utility\PHPEnvironment;

$files = array(
    __DIR__ . '/../../../autoload.php',
    __DIR__ . '/../vendor/autoload.php',
);

$found = false;
foreach ($files as $file) {
    if (file_exists($file)) {
        require $file;
        $found = true;
        break;
    }
}

if (!$found) {
    exit(
        'You need to set up the project dependencies using the following commands:'
        . PHP_EOL .
        'curl -s http://getcomposer.org/installer | php' . PHP_EOL .
        'php composer.phar install' . PHP_EOL
    );
}

// Define application context
$_ENV['WELLCART_APPLICATION_CONTEXT'] = Application::CONTEXT_GLOBAL;

if (!defined('WELLCART_ROOT')) {
    define('WELLCART_ROOT', getcwd() . '/');
    define('WELLCART_STORAGE_PATH', WELLCART_ROOT . 'data/');
    PHPEnvironment::initialize();
    if (!is_file(WELLCART_ROOT . 'config/autoload/installed.php')) {
        exit('WellCart Application is not installed yet, please complete install wizard first.'
            . PHP_EOL);
    }
    $config = WELLCART_ROOT . 'config/application.config.php';
    $application = Application::init(
        Config::application(include $config)
    );
}

$app = new WellCart\SchemaMigration\Console\PhinxApplication(
    '0.1.0'
);
$app->run();
